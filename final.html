<!DOCTYPE html>
<html>
<meta charset="utf-8">
<style>
    .container { 
        display: flex;
    }

    .tooltip { 
        position: absolute; 
        width: 275px; 
        height: 185px; 
        pointer-events: none;
        background-color: bisque;
    }

    .exit { 
        float: right;
    }
</style>

<head> 
    <link href="nouislider.min.css" rel="stylesheet">
</head>

<body>
    <script src="nouislider.min.js"></script>
    <form>
        <input type="Button" value="Filter Gasoline" onclick="filterToGasoline()"/>
    </form>
    <form>
        <input type="Button" value="Filter E85" onclick="filterToE85()"/>
    </form>
    <div id="slider"></div>
    <div class="container">
        <svg id="Dimensions"></svg>
        <svg id="Legend1" height=300 width=450></svg>
    </div>
    <div class="container">
        <svg id="HighwayMPG-HP"></svg>
        <svg id="Legend2" height=300 width=450></svg>
    </div>
    <svg id="CityMPG-Volume"></svg>
</body>

<script src="http://d3js.org/d3.v6.min.js"></script>

<script>
  let width = 960, height = 500;
  var margin = {top: 50, right: 20, bottom: 50, left: 50};
  var graphs = [{"graph": d3.select("#Dimensions"), "title": "Length vs Height vs Width of Car", "x": "Dimensions.Length", "y": "Dimensions.Height", "z": "Dimensions.Width"}, 
                {"graph": d3.select("#HighwayMPG-HP"), "title": "Horsepower vs Highway MPG vs Fuel Type", "x": "Engine Information.Engine Statistics.Horsepower", "y": "Fuel Information.Highway mpg", "z": "Fuel Information.Fuel Type"},
                {"graph": d3.select("#CityMPG-Volume"), "title": "Volume of Car vs City MPG", "x": "Volume", "y": "Fuel Information.City mpg", "z": null}] 
  var attr_key = ["Dimensions.Length", "Dimensions.Height", "Dimensions.Width", "Fuel Information.Highway mpg", "Engine Information.Engine Statistics.Horsepower", "Fuel Information.City mpg", "Volume", "Fuel Information.Fuel Type"]
  var attr_info = {}
  var specials = {"Dimensions.Length": {"type": "x", "axis_title": "Length →"}, 
                    "Dimensions.Height": {"type": "y", "axis_title": "↑ Height"}, 
                    "Dimensions.Width": {"type": "size"}, 
                    "Fuel Information.City mpg": {"type": "y", "axis_title": "↑ City MPG"}, 
                    "Fuel Information.Highway mpg": {"type": "y", "axis_title": "↑ Highway MPG"}, 
                    "Engine Information.Engine Statistics.Horsepower": {"type": "x", "axis_title": "Horsepower →"}, 
                    "Volume": {"type": "x", "axis_title": "Volume →"}, 
                    "Fuel Information.Fuel Type": {"type": "color"}}
       
  for (var i = 0; i < graphs.length; i++) { 
      graphs[i].graph = graphs[i].graph
        .attr("width", width)
        .attr("height", height)
        .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")")
  }

  for (var i = 0; i < attr_key.length; i++) { 
    attr_info[attr_key[i]] = {"range": [], "scale": null, "axis": null, "label": "", "type": specials[attr_key[i]]["type"], "axis_title": specials[attr_key[i]]["axis_title"]}
  }

  var tooltip = d3.select("body").append("div") 
      .attr("class", "tooltip") 
      .style("opacity", 0);

  width = width - margin.left - margin.right;
  height = height - margin.top - margin.bottom;

  let masterCars, cars;
  ready();

  var circleMin = 5, circleMax = 10;

  async function ready() {
    masterCars = await d3.csv("cars.csv");
    masterCars = masterCars.slice(0, 11);
    cars = masterCars;

    var tooltip = d3.select("body").append("div") 
      .attr("class", "tooltip") 
      .style("opacity", 0);

    init();

    var slider = document.getElementById('slider');
    vals = attr_info["Fuel Information.City mpg"]["range"]

    noUiSlider.create(slider, {
        start: [vals[0], vals[1]],
        connect: true,
        range: {
            'min': vals[0],
            'max': vals[1]
        }
    });

    slider.noUiSlider.on("update", d => filterToCarMPG(+slider.noUiSlider.get()[0], 
                                                       +slider.noUiSlider.get()[1]))
  }

  function collect() {
    val = attr_key.pop(attr_key.length - 1);
    attr_key.map(function (k) { 
        temp = cars.map(d => +d[k]); 
        attr_info[k]["range"] = [d3.min(temp), d3.max(temp)];
    })
    attr_key.push(val);

    attr_info[val]["range"] = [... new Set(cars.map(d => d[val]))]
  }

  function makeRange(key) { 
    var offset = 5;
    if (key == "Dimensions.Length" || key == "Dimensions.Height") { 
        offset = 20;
    }

    var range = attr_info[key]["range"];
    var scale, axis, rlist; 

    if (attr_info[key]["type"] == "x") {
        rlist = [offset, width - offset];
    } else if (attr_info[key]["type"] == "y") {
        rlist = [height - offset, offset]; 
    } else if (attr_info[key]["type"] == "size") {
        rlist = [circleMin, circleMax];
    }

    if (attr_info[key]["type"] == "color") {
        scale = d3.scaleOrdinal()
            .domain(["Gasoline", "E85", "Compressed natural gas", "Diesel fuel"])	
            .range(["#e66101", "#fdb863", "#b2abd2", "#5e3c99"]);
    } else {
        scale = d3.scaleLinear()
            .domain([range[0], range[1]])
            .range(rlist);
    }

    if (attr_info[key]["type"] == "x") {
        axis = d3.axisBottom()	
            .scale(scale)
    } else if (attr_info[key]["type"] == "y") {
        axis = d3.axisLeft()
            .scale(scale)	
    }
    
    return [scale, axis];
  }

  function makeRanges() { 
    attr_key.map(function (val) { 
        var o = makeRange(val)
        attr_info[val]["scale"] = o[0];
        attr_info[val]["axis"] = o[1];
    })
  }

  function initAxis() {
    for (var i = 0; i < 3; i++) { 
        graphs[i].graph.append("g")	
            .attr("transform", "translate(0, " + height + ")")
            .attr("id", "xAxis")
            .call(attr_info[graphs[i].x]["axis"])
            .call(g => g.append("text")
                .attr("x", width)
                .attr("y", margin.bottom - 5)
                .attr("fill", "currentColor")
                .attr("text-anchor", "end")
                .text(attr_info[graphs[i].x]["axis_title"]));

        graphs[i].graph.append("g")
            .attr("id", "yAxis")	
            .call(attr_info[graphs[i].y]["axis"])
            .call(g => g.append("text")
                .attr("x", -margin.left)
                .attr("y", -5)
                .attr("fill", "currentColor")
                .attr("text-anchor", "start")
                .text(attr_info[graphs[i].y]["axis_title"]));

        graphs[i].graph.append("text")
            .attr("x", (width / 2))             
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")  
            .style("font-size", "16px")  
            .text(graphs[i].title);
    }
  }

  function updateAxis() { 
    for (var i = 0; i < 3; i++) { 
        graphs[i].graph.selectAll("#xAxis")
            .call(attr_info[graphs[i].x]["axis"])
        
        graphs[i].graph.selectAll("#yAxis")
            .call(attr_info[graphs[i].y]["axis"])
    }
  }

  function remakeOneGraph(i) { 
    var graphInfo = graphs[i]

    var enterList = (i == 0 || i == 2) ? [["stroke", "black"], ["fill-opacity", 0]] : [["opacity", 0.8], ["opacity", 0.8]]; 
    var mergeList = [graphInfo.x, graphInfo.y, graphInfo.z, graphInfo.z];
    var attrList = ["cx", "cy", "r", "fill"]
    mergeList = mergeList.map((val, i) => {return {"attr": attrList[i], "key": val}});
    mergeList = mergeList.map(function (obj) { 
        var key = obj.key, res = {"attr": obj.attr, "val": d => {return attr_info[key]["scale"](+d[key])}};
        if (obj.attr == "r" && (key == null || attr_info[key].type != "size")) { 
            res.val = "5";
        } else if (obj.attr == "fill" && (key == null || attr_info[key].type != "color")) { 
            res.val = "white";
        }
        return res;
    }) 

    var circles = graphInfo.graph.selectAll("circle")	
        .data(cars);

    circles.exit().remove();

    circles = circles.enter().append("circle")
        .attr(enterList[0][0], enterList[0][1])
        .attr(enterList[1][0], enterList[1][1])	
        .on("mouseout", function(d) { 
            tooltip.transition() 
                .duration(200) 
                .style("opacity", 0); 
        })
    .merge(circles) 
        .attr(mergeList[0].attr, mergeList[0].val)
        .attr(mergeList[1].attr, mergeList[1].val)
        .attr(mergeList[2].attr, mergeList[2].val)
        .attr(mergeList[3].attr, mergeList[3].val)
        .on("mouseover", function(event, d, i) { 
            tooltip.transition() 
                .duration(200) 
                .style("opacity", .9); 
            updateTooltip(+d["ID"] - 1, event.pageX, event.pageY)
        });
  }

  function remakeGraph() { 
      for (var i = 0; i < 3; i++) { 
          remakeOneGraph(i);
      }
  }

  function makeLegend() { 
    for (var i = 0; i < 2; i++) {
        legend = d3.select("#Legend" + (i + 1)); 

        legend.append("text")
            .attr("x", 0)
            .attr("y", function(d, i){ return 75})
            .attr("text-anchor", "left")
            .style("font-size", "20px") 
            .style("alignment-baseline", "middle");

        (i == 1) ? legend.select("text").text("Fuel Type") : legend.select("text").text("Width");
    
    }
  }

  function updateLegend() { 
    legend1 = d3.select("#Legend1"); 

    // Quick fix: will probably not get away with this
    //legend1.selectAll("*").remove(); 
    // makeLegend();

    var keys = [0, 1, 2, 3];
    var quartiles = d3.scaleLinear()
        .domain([0, 3])	
        .range([attr_info[graphs[0].z]["range"][0], attr_info[graphs[0].z]["range"][1]]);
    keys = keys.map(k => quartiles(k));
    console.log(keys);

    var circles1 = legend1.selectAll("circle")
        .data(keys)
        
    circles1.enter()
        .append("circle")
            .attr("stroke", "black")
            .attr("fill", "none")
            .attr("cx", attr_info[graphs[0].z]["scale"](quartiles(3)) + 5)
            .attr("cy", function(d, i){ return 100 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
            .attr("r", function(d, i) {return attr_info[graphs[0].z]["scale"](d)})
        .merge(circles1);
    circles1.exit().remove();

    var labels1 = legend1.selectAll("#labels")
        .data(keys);
    labels1.enter()
        .append("text")
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .attr("x", attr_info[graphs[0].z]["scale"](quartiles(3)) + 25)
            .attr("y", function(d, i){ return 100 + i*25})
            .attr("id", "labels")
        .merge(labels1) // 100 is where the first dot appears. 25 is the distance between dots
            .text(function(d, i) { return Number(d.toFixed(0))});
    labels1.exit().remove();

    legend2 = d3.select("#Legend2"); 

    // Here too
    // legend2.selectAll("*").remove();

    keys = attr_info[graphs[1].z]["range"];

    var circles2 = legend2.selectAll("circle")
        .data(keys);
    circles2.enter()
        .append("circle")
            .attr("cx", 5)
            .attr("r", 5)
            .attr("cy", function(d, i){ return 100 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
        .merge(circles2)
            .attr("fill", function(d, i) {return attr_info[graphs[1].z]["scale"](d)}); 
    circles2.exit()
        .remove();

    var labels2 = legend2.selectAll("#labels")
        .data(keys);

    labels2.enter()
        .append("text")
            .attr("x", 25)
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .attr("y", function(d,i){ return 100 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
            .attr("id", "labels") 
        .merge(labels2)
            .attr("fill", function(d, i) { return attr_info[graphs[1].z]["scale"](d)})
            .text(function(d, i) { return d});
    labels2.exit().remove();
  }

  function update() { 
      collect(); 
      makeRanges(); 
      updateAxis();
      remakeGraph();
      updateLegend();
  }

  function init() { 
      collect(); 
      makeRanges(); 
      initAxis();
      remakeGraph();
      makeLegend();
      updateLegend();
  }


  // Add switches to keep track of what has been pressed to adjust based on master. Use big update function to update switches and data. 
  function filterToGasoline() { 
      cars = cars.filter(d => d["Fuel Information.Fuel Type"] == "Gasoline");
      update();
  }

  function filterToE85() { 
      cars = cars.filter(d => d["Fuel Information.Fuel Type"] == "E85");
      update();
  }

  function filterToCarMPG(lb, ub) { 
      // Temp fix for now, refer to above comment for permanent fix.
      cars = masterCars.filter(d => d["Fuel Information.City mpg"] >= lb &&  d["Fuel Information.City mpg"] <= ub);
      update();
  }

  function updateTooltip(id, x, y) { 
      var data = masterCars[id]
      tooltip.html(data["Identification.ID"] + "<br>" + data["Engine Information.Transmission"] + 
      "<br>Highway MPG: " + data["Fuel Information.Highway mpg"] + "<br>City MPG: " + data["Fuel Information.City mpg"] + 
      "<br>Fuel Type: " + data["Fuel Information.Fuel Type"] + "<br>" + data["Engine Information.Engine Type"] + "<br>" + 
      data["Engine Information.Driveline"] + "<br>LxWxH: " + data["Dimensions.Length"] + "x" + data["Dimensions.Width"] + 
      "x" + data["Dimensions.Height"])
        .style("left", (x + 5) + "px") 
        .style("top", (y - 30) + "px");
  }

</script>


</html>
