<!DOCTYPE html>
<html>
<meta charset="utf-8">
<style>
    .rows { 
        display: flex;
    }

    .cols { 
        display: flex;
        width: 350px;
        /* height: 100vh; */
        flex-direction: column;
        justify-content: space-evenly;
    }

    .tooltip { 
        position: absolute; 
        width: 275px; 
        height: 185px; 
        pointer-events: none;
        background-color: bisque;
    }

    .exit { 
        float: right;
    }

    .noUi-target { 
        width: 260px;
        margin-bottom: 5px;
    }

    .noUi-horizontal .noUi-handle { 
        width: 10px !important;
        height: 25px !important;
        content: none !important; 
        right: -8px !important;
    }

    .noUi-handle:after, .noUi-handle:before { 
        content: none !important; 
    }

    .legend { 
        height: 200px; 
        width: 190px;
    }

    .sliderBox { 
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100px; 
        width: 350px;
        border-color: black;
        border-style: solid;
        flex-wrap: wrap;
        align-content: center;
    }

    b { 
        text-align: center;
    }

    .buttons { 
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        width: 350px; 
        flex-wrap: wrap;
    }
    
</style>

<head> 
    <link href="nouislider.min.css" rel="stylesheet">
</head>

<body>
    <script src="nouislider.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/wnumb@1.2.0/wNumb.js"></script>

    <div class="rows">
        <div id="graphs">
            <div class="rows">
                <svg id="Dimensions"></svg>
                <svg id="Legend1" class="legend"></svg>
            </div>
            <div class="rows">
                <svg id="HighwayMPG-HP"></svg>
                <svg id="Legend2" class="legend"></svg>
            </div>
            <svg id="CityMPG-Volume"></svg>
        </div>

        <div class="cols"></div>
    </div>
    
    
</body>

<script src="http://d3js.org/d3.v6.min.js"></script>

<script>
  // TODO: Email Prof in response regarding formatting. 

  let width = 960, height = 500;
  var margin = {top: 50, right: 20, bottom: 50, left: 50};
  var graphs = [d3.select("#Dimensions"), d3.select("#HighwayMPG-HP"), d3.select("#CityMPG-Volume")]
  var attr_key = []
  var attr_info = {}
  var query_attr;
  var queries = []
       
  for (var i = 0; i < graphs.length; i++) { 
      graphs[i] = graphs[i]
        .attr("width", width)
        .attr("height", height)
        .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")")
  }

  var tooltip = d3.select("body").append("div") 
      .attr("class", "tooltip") 
      .style("opacity", 0);

  width = width - margin.left - margin.right;
  height = height - margin.top - margin.bottom;

  let masterCars, cars;
  ready();

  var circleMin = 5, circleMax = 10;

  //////////////////
  // Data loading //
  //////////////////

  async function ready() {
    masterCars = await d3.csv("cars.csv");
    cars = masterCars;

    attr_data = await d3.csv("attr_info.csv");
    graph_info = await d3.csv("graph_info.csv");
    query_attr = await d3.json("query_attr.json")

    attr_data.map(d => {attr_info[d.name] = d; attr_key.push(d.name)});
    graphs = graph_info.map((d, i) => {d.graph = graphs[i]; return d;})

    var tooltip = d3.select("body").append("div") 
      .attr("class", "tooltip") 
      .style("opacity", 0);

    init();
  }

  ////////////////////////
  // Input Construction //
  ////////////////////////

  function makeButtons() { 
    var buttonList = query_attr.buttons; 
    bWraps = d3.selectAll(".cols")
    for (var i = 0; i < buttonList.length; i++) { 
        bWraps.append("div")
            .attr("class", "buttonBox") 
            .attr("id", String.fromCharCode(i + 65))
            .html("<b>" + buttonList[i].slice(buttonList[i].lastIndexOf(".") + 1) + "</b>");
        
        var id = "#" + String.fromCharCode(i + 65);
        var t = d3.select(id).append("div") 
            .attr("class", "buttons"); 
        
        var options = [... new Set(masterCars.map(d => d[buttonList[i]]))];

        for (var j = 0; j < options.length; j++) {
            var input = [buttonList[i], options[j]];
            d3.select(id).select(".buttons").append("input") 
                .attr("type", "Button") 
                .attr("value", options[j])
                .attr("id", buttonList[i] + ", " + options[j])
                .attr("onClick", "sendName(this.id)");
        }
    }
  }

  function makeSliders() { 
    var sliderList = query_attr.sliders; 
    sWraps = d3.selectAll(".cols")
    for (var i = 0; i < sliderList.length; i++) { 
        bWraps.append("div")
            .attr("class", "sliderBox") 
            .attr("id", String.fromCharCode(i + 97))
            .html("<b>" + sliderList[i].slice(sliderList[i].lastIndexOf(".") + 1) + "</b>");
        
        var id = "#" + String.fromCharCode(i + 97);
        var t = d3.select(id).append("div") 
            .attr("id", id + id); 
        
        var entry = attr_info[sliderList[i]]
        var vals;
        if (entry != null) { 
            vals = entry["range"]; 
        } else { 
            var nums = masterCars.map(d => +d[sliderList[i]]);
            vals = [d3.min(nums), d3.max(nums)];
        }

        var tooltipSlider = document.getElementById(id + id);
        noUiSlider.create(tooltipSlider, {
            start: [vals[0], vals[1]],
            tooltips: [wNumb({decimals: 0}), wNumb({decimals: 0})],
            connect: true,
            range: {
                'min': vals[0],
                'max': vals[1]
            }
        });
        tooltipSlider.noUiSlider.on("update", _ => {sendName([sliderList[i], vals]);})
    }
  }

  ///////////////////////////////
  // Data Collections/Creation //
  ///////////////////////////////

  function collect() {
    val = attr_key.pop(attr_key.length - 1);
    attr_key.map(function (k) { 
        temp = cars.map(d => +d[k]); 
        attr_info[k]["range"] = [d3.min(temp), d3.max(temp)];
    })
    attr_key.push(val);

    attr_info[val]["range"] = [... new Set(cars.map(d => d[val]))]
  }

  function makeRange(key) { 
    var offset = 5;
    if (key == "Dimensions.Length" || key == "Dimensions.Height") { 
        offset = 20;
    }

    var range = attr_info[key]["range"];
    var scale, axis, rlist; 

    if (attr_info[key]["type"] == "x") {
        rlist = [offset, width - offset];
    } else if (attr_info[key]["type"] == "y") {
        rlist = [height - offset, offset]; 
    } else if (attr_info[key]["type"] == "size") {
        rlist = [circleMin, circleMax];
    }

    if (attr_info[key]["type"] == "color") {
        scale = d3.scaleOrdinal()
            .domain(["Gasoline", "E85", "Compressed natural gas", "Diesel fuel"])	
            .range(["#e66101", "#fdb863", "#b2abd2", "#5e3c99"]);
    } else {
        scale = d3.scaleLinear()
            .domain([range[0], range[1]])
            .range(rlist);
    }

    if (attr_info[key]["type"] == "x") {
        axis = d3.axisBottom()	
            .scale(scale)
    } else if (attr_info[key]["type"] == "y") {
        axis = d3.axisLeft()
            .scale(scale)	
    }
    
    return [scale, axis];
  }

  function makeRanges() { 
    attr_key.map(function (val) { 
        var o = makeRange(val)
        attr_info[val]["scale"] = o[0];
        attr_info[val]["axis"] = o[1];
    })
  }

  //////////////////
  // Graph Making //
  //////////////////

  // Axis 
  function initAxis() {
    for (var i = 0; i < 3; i++) { 
        graphs[i].graph.append("g")	
            .attr("transform", "translate(0, " + height + ")")
            .attr("id", "xAxis")
            .call(attr_info[graphs[i].x]["axis"])
            .call(g => g.append("text")
                .attr("x", width)
                .attr("y", margin.bottom - 10)
                .attr("fill", "currentColor")
                .attr("text-anchor", "end")
                .text(attr_info[graphs[i].x]["axis_title"] + " \u2192"));

        graphs[i].graph.append("g")
            .attr("id", "yAxis")	
            .call(attr_info[graphs[i].y]["axis"])
            .call(g => g.append("text")
                .attr("x", -margin.left/2)
                .attr("y", -5)
                .attr("fill", "currentColor")
                .attr("text-anchor", "start")
                .text("\u2191 " + attr_info[graphs[i].y]["axis_title"]));

        graphs[i].graph.append("text")
            .attr("x", (width / 2))             
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")  
            .style("font-size", "16px")  
            .text(graphs[i].title);
    }
  }

  function updateAxis() { 
    for (var i = 0; i < 3; i++) { 
        graphs[i].graph.selectAll("#xAxis")
            .call(attr_info[graphs[i].x]["axis"])
        
        graphs[i].graph.selectAll("#yAxis")
            .call(attr_info[graphs[i].y]["axis"])
    }
  }

  // Graph
  function remakeOneGraph(i) { 
    var graphInfo = graphs[i]

    var enterList = (i == 0 || i == 2) ? [["stroke", "black"], ["fill-opacity", 0]] : [["opacity", 0.8], ["opacity", 0.8]]; 
    var mergeList = [graphInfo.x, graphInfo.y, graphInfo.z, graphInfo.z];
    var attrList = ["cx", "cy", "r", "fill"]
    mergeList = mergeList.map((val, i) => {return {"attr": attrList[i], "key": val}});
    mergeList = mergeList.map(function (obj) { 
        var key = obj.key, res = {"attr": obj.attr, "val": d => {return attr_info[key]["scale"](+d[key])}};
        if (obj.attr == "r" && (attr_info[key] == null || attr_info[key].type != "size")) { 
            res.val = "5";
        } else if (obj.attr == "fill" && (attr_info[key] == null || attr_info[key].type != "color")) { 
            res.val = "white";
        } else if (obj.attr == "fill") { 
            res.val = d => {return attr_info[key]["scale"](d[key])};
        }
        return res;
    }) 

    var circles = graphInfo.graph.selectAll("circle")	
        .data(cars);

    circles.exit().remove();

    circles = circles.enter().append("circle")
        .attr(enterList[0][0], enterList[0][1])
        .attr(enterList[1][0], enterList[1][1])	
        .on("mouseout", function(d) { 
            tooltip.transition() 
                .duration(200) 
                .style("opacity", 0); 
        })
    .merge(circles) 
        .attr(mergeList[0].attr, mergeList[0].val)
        .attr(mergeList[1].attr, mergeList[1].val)
        .attr(mergeList[2].attr, mergeList[2].val)
        .attr(mergeList[3].attr, mergeList[3].val)
        .on("mouseover", function(event, d, i) { 
            tooltip.transition() 
                .duration(200) 
                .style("opacity", .9); 
            updateTooltip(+d["ID"] - 1, event.pageX, event.pageY)
        });
  }

  function remakeGraph() { 
      for (var i = 0; i < 3; i++) { 
          remakeOneGraph(i);
      }
  }


  // Legends 
  function makeLegend() { 
    for (var i = 0; i < 2; i++) {
        legend = d3.select("#Legend" + (i + 1)); 

        legend.append("text")
            .attr("x", 0)
            .attr("y", function(d, i){ return 75})
            .attr("text-anchor", "left")
            .style("font-size", "20px") 
            .style("alignment-baseline", "middle");

        (i == 1) ? legend.select("text").text("Fuel Type") : legend.select("text").text("Width");
    
    }
  }

  function updateLegend() { 
    // TODO: Look into modularing this

    var keys = [...Array(Math.min(4, cars.length)).keys()];
    var quartiles = d3.scaleLinear()
        .domain([0, 3])	
        .range([attr_info[graphs[0].z]["range"][0], attr_info[graphs[0].z]["range"][1]]);
    keys = keys.map(k => quartiles(k));
    console.log(keys);

    legend1 = d3.select("#Legend1"); 
    var circles1 = legend1.selectAll("circle")
        .data(keys)
        
    circles1.enter()
        .append("circle")
            .attr("stroke", "black")
            .attr("fill", "none")
            .attr("cx", attr_info[graphs[0].z]["scale"](quartiles(3)) + 5)
            .attr("cy", function(d, i){ return 100 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
            .attr("r", function(d, i) {return attr_info[graphs[0].z]["scale"](d)})
        .merge(circles1);
    circles1.exit().remove();

    var labels1 = legend1.selectAll("#labels")
        .data(keys);
    labels1.enter()
        .append("text")
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .attr("x", attr_info[graphs[0].z]["scale"](quartiles(3)) + 25)
            .attr("y", function(d, i){ return 100 + i*25})
            .attr("id", "labels")
        .merge(labels1) // 100 is where the first dot appears. 25 is the distance between dots
            .text(function(d, i) { return Number(d.toFixed(0))});
    labels1.exit().remove();

    legend2 = d3.select("#Legend2"); 

    keys = attr_info[graphs[1].z]["range"];

    var circles2 = legend2.selectAll("circle")
        .data(keys);
    circles2.enter()
        .append("circle")
            .attr("cx", 5)
            .attr("r", 5)
            .attr("cy", function(d, i){ return 100 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
        .merge(circles2)
            .attr("fill", function(d, i) {return attr_info[graphs[1].z]["scale"](d)}); 
    circles2.exit()
        .remove();

    var labels2 = legend2.selectAll("#labels")
        .data(keys);

    labels2.enter()
        .append("text")
            .attr("x", 25)
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .attr("y", function(d,i){ return 100 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
            .attr("id", "labels") 
        .merge(labels2)
            .attr("fill", function(d, i) { return attr_info[graphs[1].z]["scale"](d)})
            .text(function(d, i) { return d});
    labels2.exit().remove();
  }

  ////////////////////
  // Main functions //
  ////////////////////
  function update() { 
      collect(); 
      makeRanges(); 
      updateAxis();
      remakeGraph();
      updateLegend();
  }

  function init() { 
      collect(); 
      makeRanges(); 
      initAxis();
      remakeGraph();
      makeLegend();
      updateLegend();
      makeButtons();
      makeSliders();
  }


  ///////////////
  // Filtering //
  ///////////////

  // Refer class code to go about filtering 
  function filterToGasoline() { 
      cars = cars.filter(d => d["Fuel Information.Fuel Type"] == "Gasoline");
      update();
  }

  function filterToE85() { 
      cars = cars.filter(d => d["Fuel Information.Fuel Type"] == "E85");
      update();
  }

  function filterToCarMPG(lb, ub) { 
      // Temp fix for now, refer to above comment for permanent fix.
      cars = masterCars.filter(d => d["Fuel Information.City mpg"] >= lb &&  d["Fuel Information.City mpg"] <= ub);
      update();
  }

  function sendName(attrAdj) { 
      // TODO: This needs to be updated to update queries for filtering
      // Plan: buttons blur out and sliders disable (max = min) when query doesnt apply to certain points anymore 
      //       light up buttons that are selected 
      //       buttons that can still work and are not selected are normal colors
      //       update slider max and min as well
      if (typeof attrAdj == "string") { 
          attrAdj = [attrAdj.slice(0, attrAdj.lastIndexOf(",")), attrAdj.slice(attrAdj.lastIndexOf(",") + 1)]
      }
      queries.push(attrAdj);
      console.log(queries);
  }

  /////////////
  // Tooltip //
  /////////////

  function updateTooltip(id, x, y) { 
      var data = masterCars[id]
      tooltip.html(data["Identification.ID"] + "<br>" + data["Engine Information.Transmission"] + 
      "<br>Highway MPG: " + data["Fuel Information.Highway mpg"] + "<br>City MPG: " + data["Fuel Information.City mpg"] + 
      "<br>Fuel Type: " + data["Fuel Information.Fuel Type"] + "<br>" + data["Engine Information.Engine Type"] + "<br>" + 
      data["Engine Information.Driveline"] + "<br>LxWxH: " + data["Dimensions.Length"] + "x" + data["Dimensions.Width"] + 
      "x" + data["Dimensions.Height"])
        .style("left", (x + 5) + "px") 
        .style("top", (y - 30) + "px");
  }

</script>


</html>
